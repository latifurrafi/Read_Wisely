{% extends "base.html" %}
{% block title %}Book Library{% endblock %}
{% block content %}

<!-- Page header with actions -->
<div class="flex flex-col md:flex-row md:justify-between md:items-center pb-4 mb-6 border-b border-gray-200 gap-4">
  <div>
    <h2 class="text-2xl font-bold text-gray-800">Book Library</h2>
    <p class="text-gray-500 text-sm mt-1">Manage your collection of {{ books.count|default:"0" }} books</p>
  </div>

  <div class="flex flex-wrap gap-2">
    {% if user.is_authenticated %}
    <a href="{% url 'add_book' %}"
      class="inline-flex items-center px-3 py-1.5 bg-primary-600 text-white rounded-md text-sm hover:bg-primary-700 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      Add Book
    </a>
    {% endif %}

    <button id="view-toggle"
      class="inline-flex items-center px-3 py-1.5 border border-gray-300 bg-white text-gray-700 rounded-md text-sm hover:bg-gray-50 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 grid-icon" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 list-icon hidden" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      <span class="view-text">Grid View</span>
    </button>

    <div class="relative filter-dropdown">
      <button id="filter-toggle"
        class="inline-flex items-center px-3 py-1.5 border border-gray-300 bg-white text-gray-700 rounded-md text-sm hover:bg-gray-50 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        Filter
      </button>
      <div id="filter-dropdown-content"
        class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-10 p-4">
        <h3 class="font-medium text-gray-700 mb-2">Filter Books</h3>
        <form id="filter-form" class="space-y-3">
          <div>
            <label for="category-filter" class="block text-sm text-gray-600">Category</label>
            <select id="category-filter" name="category"
              class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
              <option value="">All Categories</option>
              <option value="fiction">Fiction</option>
              <option value="non-fiction">Non-Fiction</option>
              <option value="science">Science</option>
              <option value="history">History</option>
              <option value="biography">Biography</option>
            </select>
          </div>
          <div>
            <label for="year-filter" class="block text-sm text-gray-600">Published Year</label>
            <div class="flex space-x-2">
              <input type="number" id="year-from" name="year_from" placeholder="From"
                class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
              <input type="number" id="year-to" name="year_to" placeholder="To"
                class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
            </div>
          </div>
          <div>
            <label for="status-filter" class="block text-sm text-gray-600">Reading Status</label>
            <select id="status-filter" name="status"
              class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
              <option value="">All Statuses</option>
              <option value="read">Read</option>
              <option value="reading">Currently Reading</option>
              <option value="to-read">To Read</option>
            </select>
          </div>
          <div class="pt-2 flex justify-end space-x-2">
            <button type="reset"
              class="px-3 py-1.5 border border-gray-300 bg-white text-gray-700 rounded-md text-xs hover:bg-gray-50 transition-colors">
              Reset
            </button>
            <button type="submit"
              class="px-3 py-1.5 bg-primary-600 text-white rounded-md text-xs hover:bg-primary-700 transition-colors">
              Apply Filters
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="relative sort-dropdown">
      <button id="sort-toggle"
        class="inline-flex items-center px-3 py-1.5 border border-gray-300 bg-white text-gray-700 rounded-md text-sm hover:bg-gray-50 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
        </svg>
        Sort
      </button>
      <div id="sort-dropdown-content" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
        <div class="py-1">
          <a href="?sort=title" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Title (A-Z)</a>
          <a href="?sort=-title" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Title (Z-A)</a>
          <a href="?sort=year" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Year (Oldest first)</a>
          <a href="?sort=-year" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Year (Newest first)</a>
          <a href="?sort=author" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Author (A-Z)</a>
          <a href="?sort=-author" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Author (Z-A)</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Search bar -->
<div class="mb-6">
  <form method="GET" action="{% url 'search_book' %}" class="flex w-full md:max-w-md">
    <div class="relative flex-grow">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      <input type="search" name="q" id="search"
        class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
        placeholder="Search books by title, author, or ISBN..." value="{{ query }}">
    </div>
    <button type="submit"
      class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-r-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
      Search
    </button>
  </form>

</div>

<!-- Selected categories/tags -->
<div class="flex flex-wrap gap-2 mb-6" id="active-filters">
  <!-- These would be dynamically generated based on active filters -->
  <div
    class="hidden active-filter inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
    Fiction
    <button type="button" class="ml-1 inline-flex text-blue-500 focus:outline-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
</div>

<!-- Book selection tools (for batch operations) -->
<div id="batch-operations" class="hidden mb-6 p-3 bg-gray-100 rounded-md flex items-center justify-between">
  <div class="flex items-center">
    <input type="checkbox" id="select-all"
      class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
    <label for="select-all" class="ml-2 text-sm text-gray-700">Select All</label>
    <span class="ml-3 text-sm text-gray-500" id="selected-count">0 selected</span>
  </div>
  <div class="flex space-x-2">
    <button type="button"
      class="inline-flex items-center px-3 py-1.5 border border-gray-300 bg-white text-gray-700 rounded-md text-xs hover:bg-gray-50 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
      </svg>
      Export
    </button>
    <button type="button"
      class="inline-flex items-center px-3 py-1.5 border border-transparent bg-red-600 text-white rounded-md text-xs hover:bg-red-700 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
      Delete Selected
    </button>
  </div>
</div>

<!-- Grid view (default) -->
<div id="grid-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for book in books %}
  <div
    class="bg-white rounded-lg shadow-md overflow-hidden h-full flex flex-col transition-transform hover:shadow-lg hover:-translate-y-1">
    <!-- Book selection checkbox (hidden by default) -->
    <div class="book-checkbox absolute top-2 left-2 hidden">
      <input type="checkbox" name="selected_books" value="{{ book.id }}"
        class="h-5 w-5 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
    </div>

    <!-- Reading status indicator -->
    <div class="absolute top-2 right-2">
      {% if book.status == 'reading' %}
      <span
        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
        Reading
      </span>
      {% elif book.status == 'read' %}
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
        Read
      </span>
      {% elif book.status == 'to-read' %}
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
        To Read
      </span>
      {% endif %}
    </div>

    <!-- Book cover with overlay for quick actions -->
    <div class="relative h-64 overflow-hidden group">
      {% if book.image_url %}
      <img src="{{ book.image_url }}" alt="{{ book.title }}"
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
      {% elif book.image %}
      <img src="{{ book.image.url }}" alt="{{ book.title }}"
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
      {% else %}
      <img src="/static/default.jpg" alt="default"
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
      {% endif %}

      <!-- Overlay with quick actions -->
      <div
        class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center space-x-3">
        <a href="{% url 'book_detail' book.id %}" class="p-2 bg-white rounded-full hover:bg-gray-100 transition-colors"
          title="View Details">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </a>
        {% if user.is_authenticated %}
        <a href="{% url 'update_book' book.id %}" class="p-2 bg-white rounded-full hover:bg-gray-100 transition-colors"
          title="Edit Book">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        </a>
        <button type="button" class="toggle-favorite p-2 bg-white rounded-full hover:bg-gray-100 transition-colors"
          title="Add to Favorites" data-book-id="{{ book.id }}">
          <svg xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 text-gray-700 {% if book.is_favorite %}hidden{% endif %}" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 text-red-500 {% if not book.is_favorite %}hidden{% endif %}" viewBox="0 0 20 20"
            fill="currentColor">
            <path fill-rule="evenodd"
              d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
              clip-rule="evenodd" />
          </svg>
        </button>
        {% endif %}
      </div>
    </div>

    <div class="p-4 flex-grow">
      <!-- Title and rating -->
      <div class="flex justify-between items-start mb-1">
        <h5 class="text-lg font-semibold text-gray-800">{{ book.title }}</h5>
        <div class="flex text-yellow-400 ml-2">
          <!-- Star rating (example) -->

        </div>
      </div>

      <!-- Author -->
      <h6 class="text-sm text-gray-500 mb-3">
        {% for author in book.author.all %}
        {{ author.name }}{% if not forloop.last %}, {% endif %}
        {% empty %}
        Unknown Author
        {% endfor %}
      </h6>

      <!-- Description -->
      <p class="text-gray-700 mb-4 text-sm">{{ book.description|truncatechars:100 }}</p>

      <!-- Book metadata -->
      <div class="grid grid-cols-2 gap-2 mb-4">
        <p class="text-xs"><span class="font-medium text-gray-700">Published:</span> {{ book.year }}</p>
        <p class="text-xs"><span class="font-medium text-gray-700">Pages:</span> {{ book.page|default:"Unknown" }}</p>
        <p class="text-xs"><span class="font-medium text-gray-700">Category:</span>
          {% for category in book.categories.all %}
          {{ category.name }} {% if not forloop.last %}, {% endif %}
          {% endfor %}
        </p>
        <p class="text-xs"><span class="font-medium text-gray-700">Language:</span> {{ book.language|default:"Unknown"}}</p>
      </div>

      <!-- Tags -->
      <div class="flex flex-wrap gap-1 mb-2">
        {% for tag in book.tags.all %}
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
          {{ tag.name }}
        </span>
        {% endfor %}
      </div>
    </div>

    <div class="px-4 py-3 bg-gray-50 flex space-x-2 mt-auto">
      {% if user.is_authenticated %}
      <a href="{% url 'update_book' book.id %}"
        class="px-3 py-1.5 bg-primary-600 text-white rounded-md text-xs hover:bg-primary-700 transition-colors">Update</a>
      <a href="{% url 'delete_book' book.id %}"
        class="px-3 py-1.5 bg-red-600 text-white rounded-md text-xs hover:bg-red-700 transition-colors">Delete</a>
      {% endif %}
      <a href="{% url 'book_detail' book.id %}"
        class="px-3 py-1.5 bg-blue-500 text-white rounded-md text-xs hover:bg-blue-600 transition-colors">Read More</a>

      <!-- Reading status dropdown -->
      {% if user.is_authenticated %}
      <div class="relative ml-auto book-status-dropdown">
        <button id="book-status-toggle-{{ book.id }}" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
        </button>
        <div id="book-status-dropdown-content-{{ book.id }}" class="hidden absolute right-0 bottom-full mb-2 w-48 bg-white rounded-md shadow-lg z-10">
            <div class="py-1">
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 update-status" onclick="updateBookStatus({{ book.id }}, 'reading')">
                    <span class="inline-block w-3 h-3 rounded-full bg-yellow-400 mr-2"></span>
                    Currently Reading
                </a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 update-status" onclick="updateBookStatus({{ book.id }}, 'read')">
                    <span class="inline-block w-3 h-3 rounded-full bg-green-400 mr-2"></span>
                    Finished Reading
                </a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 update-status" onclick="updateBookStatus({{ book.id }}, 'to-read')">
                    <span class="inline-block w-3 h-3 rounded-full bg-blue-400 mr-2"></span>
                    Want to Read
                </a>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          // Book status dropdown functionality
          const bookStatusToggles = document.querySelectorAll("[id^='book-status-toggle-']");

          bookStatusToggles.forEach(toggle => {
              toggle.addEventListener("click", function(event) {
                  event.preventDefault();

                  // Extract book ID from the button ID
                  const bookId = this.id.replace('book-status-toggle-', '');
                  const dropdownContent = document.getElementById(`book-status-dropdown-content-${bookId}`);

                  if (dropdownContent) {
                      // Close all other dropdowns first
                      document.querySelectorAll("[id^='book-status-dropdown-content-']").forEach(dropdown => {
                          if (dropdown !== dropdownContent && !dropdown.classList.contains("hidden")) {
                              dropdown.classList.add("hidden");
                          }
                      });

                      // Toggle the current dropdown
                      dropdownContent.classList.toggle("hidden");
                  }
              });
          });

          // Close book status dropdowns when clicking outside
          document.addEventListener("click", function(event) {
              if (!event.target.closest(".book-status-dropdown")) {
                  document.querySelectorAll("[id^='book-status-dropdown-content-']").forEach(dropdown => {
                      dropdown.classList.add("hidden");
                  });
              }
          });
      });

      // Function to update book status via AJAX
      function updateBookStatus(bookId, status) {
        console.log(bookId)
          fetch(`/manage-category/update-book-status/${bookId}/${status}/`, {
              method: "GET",
              headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCsrfToken()  // Ensure CSRF is handled
              },
              // body: JSON.stringify({ book_id: bookId, status: status })

          })
          .then(response => response.json())
          .then(data => {
              if (data.status) {
                  console.log("Status updated successfully:", data);
                  alert(`Book status updated to: ${data.status}`);
              } else {
                  console.error("Failed to update status:", data.error);
              }
          })
          .catch(error => {
              console.error("Error updating book status:", error);
          });
      }



      // Function to get CSRF token from the cookies
      function getCsrfToken() {
          let csrfToken = null;
          document.cookie.split(";").forEach(cookie => {
              let [name, value] = cookie.trim().split("=");
              if (name === "csrftoken") {
                  csrfToken = value;
              }
          });
          return csrfToken;
      }

    </script>
    
      {% endif %}
    </div>
  </div>
  {% empty %}
  <div class="col-span-full">
    <div class="bg-blue-50 text-blue-800 p-8 rounded-lg text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-blue-400 mb-4" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
      <h3 class="text-xl font-semibold mb-2">No books found</h3>
      <p class="text-lg mb-4">Your library is empty or no books match your search criteria.</p>
      {% if user.is_authenticated %}
      <a href="{% url 'add_book' %}"
        class="mt-3 inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Add Your First Book
      </a>
      {% else %}
      <a href="{% url 'login' %}"
        class="mt-3 inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
        </svg>
        Sign in to Add Books
      </a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- List view (hidden by default) -->
<div id="list-view" class="hidden space-y-4">
  {% for book in books %}
  <div class="bg-white rounded-lg shadow-md overflow-hidden transition-all hover:shadow-lg">
    <div class="flex flex-col md:flex-row">
      <!-- Book selection checkbox (hidden by default) -->
      <div class="book-checkbox absolute top-2 left-2 hidden">
        <input type="checkbox" name="selected_books" value="{{ book.id }}"
          class="h-5 w-5 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
      </div>

      <!-- Book cover -->
      <div class="md:w-48 h-48 md:h-auto flex-shrink-0">
        {% if book.image_url %}
        <img src="{{ book.image_url }}" alt="{{ book.title }}" class="w-full h-full object-cover">
        {% elif book.image %}
        <img src="{{ book.image.url }}" alt="{{ book.title }}" class="w-full h-full object-cover">
        {% else %}
        <img src="/static/default.jpg" alt="default" class="w-full h-full object-cover">
        {% endif %}
      </div>

      <!-- Book details -->
      <div class="p-4 flex-grow">
        <div class="flex flex-wrap justify-between items-start">
          <div>
            <h5 class="text-lg font-semibold text-gray-800">{{ book.title }}</h5>
            <h6 class="text-sm text-gray-500">
              {% for author in book.author.all %}
              {{ author.name }}{% if not forloop.last %}, {% endif %}
              {% empty %}
              Unknown Author
              {% endfor %}
            </h6>
          </div>

          <div class="flex items-center space-x-2">
            <!-- Rating -->
            <div class="flex text-yellow-400">

            </div>

            <!-- Reading status -->
            {% if book.status == 'reading' %}
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
              Reading
            </span>
            {% elif book.status == 'read' %}
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              Read
            </span>
            {% elif book.status == 'to-read' %}
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              To Read
            </span>
            {% endif %}
          </div>
        </div>

        <p class="text-gray-700 my-3 text-sm">{{ book.description|truncatechars:200 }}</p>

        <!-- Book metadata -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3 text-xs">
          <p><span class="font-medium text-gray-700">Published:</span> {{ book.year }}</p>
          <p><span class="font-medium text-gray-700">Pages:</span> {{ book.page|default:"Unknown" }}</p>
          <p><span class="font-medium text-gray-700">Category:</span> {{ book.category|default:"Uncategorized" }}</p>
          <p><span class="font-medium text-gray-700">Language:</span> {{ book.language|default:"Unknown" }}</p>
        </div>

        <!-- Tags -->
        <div class="flex flex-wrap gap-1 mb-3">
          {% for tag in book.tags.all %}
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
            {{ tag.name }}
          </span>
          {% endfor %}
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-2 mt-3">
          {% if user.is_authenticated %}
          <a href="{% url 'update_book' book.id %}"
            class="px-3 py-1.5 bg-primary-600 text-white rounded-md text-xs hover:bg-primary-700 transition-colors">Update</a>
          <a href="{% url 'delete_book' book.id %}"
            class="px-3 py-1.5 bg-red-600 text-white rounded-md text-xs hover:bg-red-700 transition-colors">Delete</a>
          {% endif %}
          <a href="{% url 'book_detail' book.id %}"
            class="px-3 py-1.5 bg-blue-500 text-white rounded-md text-xs hover:bg-blue-600 transition-colors">Read
            More</a>

          {% if user.is_authenticated %}
          <button type="button"
            class="toggle-favorite px-3 py-1.5 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300 transition-colors"
            data-book-id="{{ book.id }}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline {% if book.is_favorite %}hidden{% endif %}"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 inline text-red-500 {% if not book.is_favorite %}hidden{% endif %}" viewBox="0 0 20 20"
              fill="currentColor">
              <path fill-rule="evenodd"
                d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                clip-rule="evenodd" />
            </svg>
            <span>{% if book.is_favorite %}Favorited{% else %}Add to Favorites{% endif %}</span>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="bg-blue-50 text-blue-800 p-8 rounded-lg text-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-blue-400 mb-4" fill="none" viewBox="0 0 24 24"
      stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
    </svg>
    <h3 class="text-xl font-semibold mb-2">No books found</h3>
    <p class="text-lg mb-4">Your library is empty or no books match your search criteria.</p>
    {% if user.is_authenticated %}
    <a href="{% url 'add_book' %}"
      class="mt-3 inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      Add Your First Book
    </a>
    {% endif %}
  </div>
  {% endfor %}
</div>

<!-- Pagination (if you have it) -->
{% if is_paginated %}
<div class="mt-8 flex justify-center">
  <nav class="inline-flex rounded-md shadow">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}"
      class="px-3 py-2 bg-white border border-gray-300 rounded-l-md text-gray-700 hover:bg-gray-50">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </a>
    {% endif %}

    <!-- Page numbers -->
    <div class="hidden md:flex">
      {% for i in paginator.page_range %}
      {% if page_obj.number == i %}
      <span class="px-3 py-2 bg-primary-50 border border-primary-300 text-primary-700">{{ i }}</span>
      {% elif i > page_obj.number|add:"-3" and i < page_obj.number|add:"3" %} <a
        href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}"
        class="px-3 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50">{{ i }}</a>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Mobile pagination info -->
    <span class="px-3 py-2 bg-primary-50 border border-primary-300 text-primary-700 md:hidden">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}"
      class="px-3 py-2 bg-white border border-gray-300 rounded-r-md text-gray-700 hover:bg-gray-50">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </a>
    {% endif %}
  </nav>
</div>
{% endif %}

<script>
  
  document.addEventListener("DOMContentLoaded", function () {
    // View toggle functionality
    const viewToggle = document.getElementById("view-toggle");
    const gridView = document.getElementById("grid-view");
    const listView = document.getElementById("list-view");
    const gridIcon = document.querySelector(".grid-icon");
    const listIcon = document.querySelector(".list-icon");
    const viewText = document.querySelector(".view-text");

    if (viewToggle && gridView && listView) {
      viewToggle.addEventListener("click", function () {
        const isListView = gridView.classList.toggle("hidden");
        listView.classList.toggle("hidden");
        gridIcon.classList.toggle("hidden");
        listIcon.classList.toggle("hidden");
        viewText.textContent = isListView ? "Grid View" : "List View";
        localStorage.setItem("bookViewPreference", isListView ? "list" : "grid");
      });

      // Apply saved preference
      if (localStorage.getItem("bookViewPreference") === "list") {
        gridView.classList.add("hidden");
        listView.classList.remove("hidden");
        gridIcon.classList.add("hidden");
        listIcon.classList.remove("hidden");
        viewText.textContent = "Grid View";
      }
    }

    // Filter dropdown functionality
    const filterToggle = document.getElementById("filter-toggle");
    const filterDropdownContent = document.getElementById("filter-dropdown-content");

    if (filterToggle && filterDropdownContent) {
      filterToggle.addEventListener("click", function () {
        filterDropdownContent.classList.toggle("hidden");
        // Close sort dropdown if open
        if (sortDropdownContent) {
          sortDropdownContent.classList.add("hidden");
        }
      });
    }

    // Sort dropdown functionality
    const sortToggle = document.getElementById("sort-toggle");
    const sortDropdownContent = document.getElementById("sort-dropdown-content");

    if (sortToggle && sortDropdownContent) {
      sortToggle.addEventListener("click", function () {
        sortDropdownContent.classList.toggle("hidden");
        // Close filter dropdown if open
        if (filterDropdownContent) {
          filterDropdownContent.classList.add("hidden");
        }
      });
    }

    // Close dropdowns when clicking outside
    document.addEventListener("click", function (event) {
      if (filterDropdownContent && !event.target.closest(".filter-dropdown") && !filterDropdownContent.classList.contains("hidden")) {
        filterDropdownContent.classList.add("hidden");
      }

      if (sortDropdownContent && !event.target.closest(".sort-dropdown") && !sortDropdownContent.classList.contains("hidden")) {
        sortDropdownContent.classList.add("hidden");
      }
    });

    // Filter form functionality
    const filterForm = document.getElementById("filter-form");
    if (filterForm) {
      filterForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const params = new URLSearchParams();

        for (const [key, value] of formData.entries()) {
          if (value) params.append(key, value);
        }

        const searchQuery = new URLSearchParams(window.location.search).get("q");
        if (searchQuery) params.append("q", searchQuery);

        window.location.href = `?${params.toString()}`;
      });

      // Reset button functionality
      filterForm.querySelector('button[type="reset"]').addEventListener("click", function () {
        document.querySelectorAll(".active-filter").forEach((filter) => filter.classList.add("hidden"));
      });
    }

    // Initialize active filters from URL params
    function initActiveFilters() {
      const params = new URLSearchParams(window.location.search);
      const activeFiltersContainer = document.getElementById("active-filters");
      if (!activeFiltersContainer) return;

      activeFiltersContainer.innerHTML = ""; // Clear existing filters

      params.forEach((value, key) => {
        if (key !== "page" && key !== "q" && value) {
          const filterTag = document.createElement("div");
          filterTag.className =
            "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800";

          const filterText = {
            category: `Category: ${value}`,
            year_from: `Year from: ${value}`,
            year_to: `Year to: ${value}`,
            status: `Status: ${value}`,
            sort: `Sorted by: ${value.replace("-", "descending ")}`,
          }[key] || `${key}: ${value}`;

          filterTag.innerHTML = `
                    ${filterText}
                    <button type="button" class="ml-1 inline-flex text-blue-500 focus:outline-none" data-param="${key}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;

          activeFiltersContainer.appendChild(filterTag);
        }
      });

      // Remove filters dynamically
      document.addEventListener("click", function (e) {
        if (e.target.closest("[data-param]")) {
          const param = e.target.closest("[data-param]").getAttribute("data-param");
          const url = new URL(window.location.href);
          url.searchParams.delete(param);
          window.location.href = url.toString();
        }
      });
    }

    initActiveFilters();
  });
</script>
{% endblock %}
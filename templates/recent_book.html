{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
<!-- Page header with decorative element -->
<div class="mb-8">
  <div class="flex items-center mb-4">
    <div class="h-1 w-10 bg-primary-600 rounded mr-2"></div>
    <span class="text-xs uppercase tracking-wider text-primary-600 font-semibold">Book Collection</span>
  </div>
  
  <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-4">
    <h1 class="text-3xl md:text-4xl font-bold font-serif text-gray-900 leading-tight">
        Recently Added
    </h1>
    
    <div class="flex items-center space-x-3">

      <a href="{% url 'book_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded-md shadow-sm hover:bg-gray-50 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
        </svg>
        View All Books
      </a>
    </div>
  </div>
</div>

<!-- Filter and sort controls -->
<div class="bg-white rounded-xl shadow-md p-4 mb-8">
  <div class="flex flex-col md:flex-row justify-between items-center gap-4">
    <!-- View options -->
    <div class="flex items-center space-x-4">
      <span class="text-sm text-gray-600">View:</span>
      <div class="flex bg-gray-100 rounded-lg p-1">
        <button id="grid-view" class="p-1.5 rounded text-primary-600 bg-white shadow-sm" title="Grid View">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
        </button>
        <button id="list-view" class="p-1.5 rounded text-gray-500 hover:text-gray-700" title="List View">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Sort options -->
    <div class="flex items-center space-x-4">
      <span class="text-sm text-gray-600">Sort by:</span>
      <select id="sort-by" class="border border-gray-300 rounded-md px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm bg-white shadow-sm">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="title-asc">Title (A-Z)</option>
        <option value="title-desc">Title (Z-A)</option>
        <option value="rating-desc">Highest Rated</option>
      </select>
    </div>
  </div>
</div>

<!-- Books grid -->
<div id="books-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
  {% if books %}
    {% for book in books %}
    <div class="  rounded-xl shadow-md overflow-hidden transition-all hover:shadow-lg hover:-translate-y-1 duration-300 flex  h-full">
      <!-- Fixed height image container with consistent dimensions -->
      <div class="relative w-full h-80 sm:h-64 md:h-56 lg:h-64 max-w-xl overflow-hidden   ">
        {% if book.image_url %}
          <img src="{{ book.image_url }}" alt="{{ book.title }}" class="w-full h-full object-cover">
        {% elif book.image %}
          <img src="{{ book.image.url }}" alt="{{ book.title }}" class="w-full h-full object-cover">
        {% else %}
          <img src="/static/default.jpg" alt="Book Cover" class="w-full h-full object-cover">
        {% endif %}
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        
        <!-- Floating action buttons -->
        <div class="absolute bottom-3 right-3 flex space-x-2">
          {% if user.is_authenticated %}
          <button class="favorite-btn p-2 bg-white rounded-full shadow-md hover:bg-gray-100 transition-colors group" data-book-id="{{ book.id }}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-red-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
          </button>
          {% endif %}
        </div>
    
      </div>
      
      <div class="p-4 flex-grow flex flex-col ">
        <!-- Book title and author -->
        <h2 class="font-bold text-gray-900 mb-1 line-clamp-1">{{ book.title }}</h2>
        <p class="text-sm text-gray-600 mb-2">
          By 
          {% for author in book.author.all %}
            <span class="font-medium">{{ author.name }}</span>{% if not forloop.last %}, {% endif %}
          {% empty %}
            <span class="font-medium">Unknown Author</span>
          {% endfor %}
        </p>
        
        <!-- Rating -->
        <div class="flex items-center mb-3">
          <div class="flex text-amber-400">
            {% with rating=book.rating|default:0 %}
              {% for i in "12345" %}
                {% if forloop.counter <= rating|floatformat:"0" %}
                  <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                  </svg>
                {% elif forloop.counter <= rating|add:0.5|floatformat:"0" %}
                  <svg class="w-4 h-4" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                    <path fill="#D1D5DB" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2V17.27z"></path>
                  </svg>
                {% else %}
                  <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 24 24">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                  </svg>
                {% endif %}
              {% endfor %}
            {% endwith %}
          </div>
          <span class="text-xs text-gray-500 ml-1">({{ book.reviews_count|default:"0" }})</span>
        </div>

        <!-- Categories -->
        <div class="mb-2">
            <p class="text-xs text-gray-600">
              <span class="font-medium">Categories:</span>
              {% if book.categories.all %}
                {% for cat in book.categories.all %}
                  <a href="{% url 'books_by_category_view' category_slug=cat.slug %}" class="hover:text-primary-600">{{ cat.name }}</a>{% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% elif book.category %}
                <a href="{% url 'books_by_category_view' category_slug=book.category.slug %}" class="hover:text-primary-600">{{ book.category }}</a>
              {% else %}
                Uncategorized
              {% endif %}
            </p>
          </div>
          
        <!-- Book details -->
        <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-4">
            <div class="grid grid-cols-2 gap-2 mb-3 text-xs">
                <p><span class="font-bold text-gray-700">Published:</span> {{ book.year|default:"Unknown" }}</p>
                <p><span class="font-medium text-gray-700">Pages:</span> {{ book.page|default:"Unknown" }}</p>
                {% if book.isbn %}
                <p class="col-span-2"><span class="font-medium text-gray-700">ISBN:</span> {{ book.isbn }}</p>
                {% endif %}
              </div>
          
        </div>
        
        <!-- Action button - pushed to bottom with mt-auto -->
        <a href="{% url 'book_detail' book_id=book.id %}" class="mt-auto inline-block w-full px-4 py-2 bg-primary-600 text-white text-center text-sm rounded-md hover:bg-primary-700 transition-colors">
          View Details
        </a>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="col-span-full bg-white rounded-xl shadow-md p-8 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
      
      <h3 class="text-xl font-bold font-serif text-gray-800 mb-2">No Books Found</h3>
      
      <p class="text-gray-600 mb-6">
        {% if filter_type == 'recent' %}
          There are no recently added books in our collection yet.
        {% elif filter_type == 'popular' %}
          There are no popular books in our collection yet.
        {% elif filter_type == 'highest_rated' %}
          There are no rated books in our collection yet.
        {% elif filter_type == 'my_books' %}
          You haven't added any books to your collection yet.
        {% else %}
          No books match your search criteria.
        {% endif %}
      </p>
      
      {% if user.is_authenticated %}
      <a href="{% url 'add_book' %}" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-md shadow-md hover:bg-primary-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Add Your First Book
      </a>
      {% endif %}
    </div>
  {% endif %}
</div>

<!-- Pagination with decorative elements -->
{% if books.has_other_pages %}
<div class="mt-12 flex flex-col items-center">
  <div class="flex items-center mb-4">
    <div class="h-px w-12 bg-gray-300"></div>
    <span class="mx-4 text-sm text-gray-500">Page {{ books.number }} of {{ books.paginator.num_pages }}</span>
    <div class="h-px w-12 bg-gray-300"></div>
  </div>
  
  <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
    {% if books.has_previous %}
    <a href="?page={{ books.previous_page_number }}{% if request.GET.filter %}&filter={{ request.GET.filter }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
      <span class="sr-only">Previous</span>
      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
      </svg>
    </a>
    {% else %}
    <span class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
      <span class="sr-only">Previous</span>
      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
      </svg>
    </span>
    {% endif %}
    
    {% for i in books.paginator.page_range %}
      {% if books.number == i %}
      <span class="relative inline-flex items-center px-4 py-2 border border-primary-500 bg-primary-50 text-sm font-medium text-primary-600">
        {{ i }}
      </span>
      {% else %}
      <a href="?page={{ i }}{% if request.GET.filter %}&filter={{ request.GET.filter }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
        {{ i }}
      </a>
      {% endif %}
    {% endfor %}
    
    {% if books.has_next %}
    <a href="?page={{ books.next_page_number }}{% if request.GET.filter %}&filter={{ request.GET.filter }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
      <span class="sr-only">Next</span>
      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
      </svg>
    </a>
    {% else %}
    <span class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
      <span class="sr-only">Next</span>
      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
      </svg>
    </span>
    {% endif %}
  </nav>
</div>
{% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const gridViewBtn = document.getElementById('grid-view');
  const listViewBtn = document.getElementById('list-view');
  const booksContainer = document.getElementById('books-container');
  const sortSelect = document.getElementById('sort-by');
  const favoriteButtons = document.querySelectorAll('.favorite-btn');
  
  // View toggle functionality
  if (gridViewBtn && listViewBtn && booksContainer) {
    // Set initial view from localStorage or default to grid
    const currentView = localStorage.getItem('bookViewMode') || 'grid';
    
    if (currentView === 'list') {
      setListView();
    }
    
    // Grid view button click
    gridViewBtn.addEventListener('click', function() {
      setGridView();
      localStorage.setItem('bookViewMode', 'grid');
    });
    
    // List view button click
    listViewBtn.addEventListener('click', function() {
      setListView();
      localStorage.setItem('bookViewMode', 'list');
    });
    
    function setGridView() {
      booksContainer.classList.remove('grid-cols-1');
      booksContainer.classList.add('grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
      
      // Update button states
      gridViewBtn.classList.remove('text-gray-500', 'hover:text-gray-700');
      gridViewBtn.classList.add('text-primary-600', 'bg-white', 'shadow-sm');
      
      listViewBtn.classList.remove('text-primary-600', 'bg-white', 'shadow-sm');
      listViewBtn.classList.add('text-gray-500', 'hover:text-gray-700');
      
      // Update book cards for grid view
      const bookCards = booksContainer.querySelectorAll('.bg-white.rounded-xl');
      bookCards.forEach(card => {
        // Remove list view specific classes
        card.classList.remove('sm:flex');
        
        // Reset image container height for grid view
        const imageContainer = card.querySelector('.relative.w-full');
        if (imageContainer) {
          imageContainer.classList.remove('sm:w-1/3', 'sm:h-auto');
          imageContainer.classList.add('h-80', 'sm:h-64', 'md:h-72', 'lg:h-80');
        }
        
        // Reset content container for grid view
        const contentContainer = card.querySelector('.p-4');
        if (contentContainer) {
          contentContainer.classList.remove('sm:w-2/3');
        }
      });
    }
    
    function setListView() {
      booksContainer.classList.remove('grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
      booksContainer.classList.add('grid-cols-1');
      
      // Update button states
      gridViewBtn.classList.remove('text-primary-600', 'bg-white', 'shadow-sm');
      gridViewBtn.classList.add('text-gray-500', 'hover:text-gray-700');
      
      listViewBtn.classList.remove('text-gray-500', 'hover:text-gray-700');
      listViewBtn.classList.add('text-primary-600', 'bg-white', 'shadow-sm');
      
      // Update book cards for list view
      const bookCards = booksContainer.querySelectorAll('.bg-white.rounded-xl');
      bookCards.forEach(card => {
        // Add list view specific classes
        card.classList.add('sm:flex');
        
        // Adjust image container for list view
        const imageContainer = card.querySelector('.relative.w-full');
        if (imageContainer) {
          imageContainer.classList.remove('h-80', 'sm:h-64', 'md:h-72', 'lg:h-80');
          imageContainer.classList.add('sm:w-1/3', 'sm:h-auto');
        }
        
        // Adjust content container for list view
        const contentContainer = card.querySelector('.p-4');
        if (contentContainer) {
          contentContainer.classList.add('sm:w-2/3');
        }
      });
    }
  }
  
  // Sorting functionality
  if (sortSelect) {
    // Set initial sort value from URL parameter or default
    const urlParams = new URLSearchParams(window.location.search);
    const sortParam = urlParams.get('sort');
    
    if (sortParam) {
      sortSelect.value = sortParam;
    }
    
    sortSelect.addEventListener('change', function() {
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('sort', this.value);
      window.location.href = currentUrl.toString();
    });
  }
  
  // Favorite button functionality
  if (favoriteButtons.length > 0) {
    favoriteButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const bookId = this.dataset.bookId;
        const icon = this.querySelector('svg');
        
        // Toggle favorite status
        fetch(`/api/books/${bookId}/favorite/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Update icon
            if (data.is_favorite) {
              icon.classList.remove('text-gray-400');
              icon.classList.add('text-red-500');
              icon.setAttribute('fill', 'currentColor');
            } else {
              icon.classList.remove('text-red-500');
              icon.classList.add('text-gray-400');
              icon.setAttribute('fill', 'none');
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      });
    });
  }
  
  // Helper function to get CSRF token
  function getCsrfToken() {
    return document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
  }
});
</script>
{% endblock %}